name: ci-deterministic

on:
  push:
  pull_request:

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        preset:
          - default
          - snark
          - ivc
          - hash
          - binius
          - stark-babybear
          - stark-goldilocks
          - stark-m31
    env:
      RUSTUP_TOOLCHAIN: nightly-2025-09-15
      RUST_MIN_STACK: "16777216"
      GLYPH_ACCEL_PROFILE: cpu
      GLYPH_BN254_SIMD: "1"
      GLYPH_BN254_MUL_MONT: "1"
      GLYPH_SUPPRESS_VENDOR_WARNINGS: "1"
      NVCC: disabled
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-15
      - name: Deterministic build
        run: |
          scripts/build/ci_deterministic_run.sh --preset "${{ matrix.preset }}" --cmd build --profile release-fast

  test-default:
    runs-on: ubuntu-latest
    needs: build-matrix
    env:
      RUSTUP_TOOLCHAIN: nightly-2025-09-15
      RUST_MIN_STACK: "16777216"
      GLYPH_ACCEL_PROFILE: cpu
      GLYPH_BN254_SIMD: "1"
      GLYPH_BN254_MUL_MONT: "1"
      GLYPH_SUPPRESS_VENDOR_WARNINGS: "1"
      GLYPH_SKIP_FUZZ: "1"
      NVCC: disabled
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-15
      - name: Deterministic tests
        run: |
          scripts/build/ci_deterministic_run.sh --preset default --cmd test --profile release-fast

  test-presets:
    runs-on: ubuntu-latest
    needs: build-matrix
    strategy:
      fail-fast: false
      matrix:
        preset:
          - snark
          - ivc
          - hash
          - binius
          - stark-babybear
          - stark-goldilocks
          - stark-m31
    env:
      RUSTUP_TOOLCHAIN: nightly-2025-09-15
      RUST_MIN_STACK: "16777216"
      GLYPH_ACCEL_PROFILE: cpu
      GLYPH_BN254_SIMD: "1"
      GLYPH_BN254_MUL_MONT: "1"
      GLYPH_SUPPRESS_VENDOR_WARNINGS: "1"
      GLYPH_SKIP_FUZZ: "1"
      NVCC: disabled
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-15
      - name: Deterministic tests (preset)
        run: |
          scripts/build/ci_deterministic_run.sh --preset "${{ matrix.preset }}" --cmd test --profile release-fast

  fuzz-short:
    runs-on: ubuntu-latest
    needs: build-matrix
    env:
      RUSTUP_TOOLCHAIN: nightly-2025-09-15
      RUST_MIN_STACK: "16777216"
      GLYPH_ACCEL_PROFILE: cpu
      GLYPH_SUPPRESS_VENDOR_WARNINGS: "1"
      NVCC: disabled
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-09-15
      - name: Install cargo-fuzz
        run: |
          cargo +nightly-2025-09-15 install cargo-fuzz --locked
      - name: Run short fuzz targets
        run: |
          mkdir -p Out/ci/fuzz
          export RUSTUP_TOOLCHAIN=nightly-2025-09-15
          FUZZ_TIME=40
          for target in decode_adapter_bytes decode_adapter_ir_deep verify_adapter_proof verify_packed_calldata transcript_challenges validate_state_transition_batch; do
            cargo +nightly-2025-09-15 fuzz run "$target" -- -max_total_time="$FUZZ_TIME"
          done
      - name: Upload fuzz artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-artifacts
          path: Out/ci/fuzz
